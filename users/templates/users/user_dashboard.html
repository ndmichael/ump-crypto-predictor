{% extends 'users/base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block content %}
<div class="container-fluid py-4">

  <!-- DASHBOARD STATS -->
  <section class="row g-3 mb-4">
    <div class="col-md-3 col-6">
      <div class="shadow-sm border-0 p-3 stat-card">
        <div class="d-flex align-items-center justify-content-between">
          <div>
            <p class="text-muted mb-1 small">Total Predictions</p>
            <h4 class="fw-bold mb-0">{{ total_predictions|default:"0" }}</h4>
          </div>
          <div class="stat-icon bg-primary-subtle text-primary">
            <i class="bi bi-bar-chart-line"></i>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-3 col-6">
      <div class="card shadow-sm border-0 p-3 stat-card">
        <div class="d-flex align-items-center justify-content-between">
          <div>
            <p class="text-muted mb-1 small">Accuracy Rate</p>
            <h4 class="fw-bold mb-0 text-success">{{ accuracy|default:"N/A" }}{% if accuracy %}%{% endif %}</h4>
          </div>
          <div class="stat-icon bg-success-subtle text-success">
            <i class="bi bi-graph-up"></i>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-3 col-6">
      <div class="card shadow-sm border-0 p-3 stat-card">
        <div class="d-flex align-items-center justify-content-between">
          <div>
            <p class="text-muted mb-1 small">Last Pair</p>
            <h4 class="fw-bold mb-0">
                {% if last_prediction %}
                    {{ last_prediction.pair.name }}
                {% else %}
                    No Data
                {% endif %}</h4>
          </div>
          <div class="stat-icon bg-warning-subtle text-warning">
            <i class="bi bi-currency-bitcoin"></i>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-3 col-6">
      <div class="card shadow-sm border-0 p-3 stat-card">
        <div class="d-flex align-items-center justify-content-between">
          <div>
            <p class="text-muted mb-1 small">Next Forecast</p>
            <h4 class="fw-bold mb-0 text-primary text-truncate" 
                style="max-width: 150px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;"
                title="{{ next_forecast|default:'Awaiting prediction...' }}">
            {{ next_forecast|default:"Awaiting prediction..." }}
            </h4>
          </div>
          <div class="stat-icon bg-primary-subtle text-primary">
            <i class="bi bi-clock-history"></i>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- PREDICTION FORM + CHART -->
  <section class="row align-items-stretch mb-5">
    <!-- Chart Card -->
    <div class="col-12">
        <div class="card chart-card border-0 shadow-sm p-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="fw-bold text-primary mb-0">
                <i class="bi bi-graph-up-arrow"></i> {{ chart_pair|default:"No Data" }}
            </h5>
            <span class="text-muted small">Predicted Trend</span>
            </div>
            <canvas id="cryptoChart" height="auto"></canvas>

            <!-- AI Insight -->
            <div class="card ai-card mt-3 border-0 shadow-sm p-3">
                <div class="d-flex justify-content-center align-items-center gap-2">
                    <i class="bi bi-activity text-primary fs-5"></i>
                    <p class="mb-0 fw-semibold text-light">
                    Market sentiment: 
                    <span class="text-warning">{{ ai_sentiment|default:"neutral" }}</span>
                    on BTC & ETH pairs.
                    </p>
                </div>
            </div>
        </div>

        
    </div>
  </section>

  <section class="row my-5">
    <div class="col-12 mx-auto">
        <div class="card chart-card border-0 shadow-sm p-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="fw-bold text-primary mb-0">
            <i class="bi bi-clock-history"></i> Recent Predictions
            </h5>
            <span class="text-muted small">Latest AI Forecasts</span>
        </div>

        <div class="table-responsive">
            <table class="table align-middle mb-0">
            <thead>
                <tr>
                <th>Pair</th>
                <th>Prediction</th>
                <th>Confidence</th>
                <th>Timestamp</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                <td>BTC/USDT</td>
                <td><span class="badge badge-success">Bullish</span></td>
                <td>94%</td>
                <td><span class="small-muted">2 mins ago</span></td>
                </tr>
                <tr>
                <td>ETH/USDT</td>
                <td><span class="badge badge-danger">Bearish</span></td>
                <td>81%</td>
                <td><span class="small-muted">15 mins ago</span></td>
                </tr>
                <tr>
                <td>XRP/USDT</td>
                <td><span class="badge badge-info">Neutral</span></td>
                <td>88%</td>
                <td><span class="small-muted">1 hr ago</span></td>
                </tr>
            </tbody>
            </table>
        </div>
        </div>
    </div>
    </section>


</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0"></script>
<script>
const ctx = document.getElementById('cryptoChart').getContext('2d');

const cryptoChart = new Chart(ctx, {
  type: 'line',
  data: {
    labels: {{ chart_labels|safe }},
    datasets: [{
      label: '{{ chart_pair|default:"Crypto" }} Predicted Price',
      data: {{ chart_data|safe }},
      borderColor: '#6366F1',
      backgroundColor: 'rgba(99, 102, 241, 0.12)',
      fill: true,
      tension: 0.4,
      pointRadius: 4,
      pointHoverRadius: 7,
      pointBackgroundColor: '#A5B4FC',
      pointHoverBackgroundColor: '#818CF8',
      borderWidth: 2.2,
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    interaction: {
      mode: 'nearest',
      axis: 'x',
      intersect: false
    },
    animations: {
      tension: {
        duration: 1000,
        easing: 'easeOutQuart',
        from: 0.3,
        to: 0.4,
        loop: false
      },
      y: {
        duration: 1200,
        easing: 'easeOutCubic',
        from: (ctx) => ctx.type === 'data' ? 0 : undefined,
        delay: (ctx) => ctx.dataIndex * 50
      },
    },
    plugins: {
      legend: {
        display: false
      },
      tooltip: {
        enabled: true,
        backgroundColor: 'rgba(15, 23, 42, 0.9)',
        borderColor: 'rgba(255, 255, 255, 0.1)',
        borderWidth: 1,
        titleColor: '#FFF',
        bodyColor: 'rgba(255,255,255,0.85)',
        titleFont: { size: 13, weight: '600', family: 'Inter, sans-serif' },
        bodyFont: { size: 12, family: 'Inter, sans-serif' },
        padding: 10,
        displayColors: false,
        cornerRadius: 8,
        caretPadding: 6,
        callbacks: {
          label: function(context) {
            return ` Price: $${context.parsed.y.toFixed(2)}`;
          },
          title: function(context) {
            return `Date: ${context[0].label}`;
          }
        }
      }
    },
    scales: {
      x: {
        grid: { color: 'rgba(255, 255, 255, 0.06)' },
        ticks: {
          color: 'rgba(235, 235, 245, 0.75)',
          font: { size: 12, weight: '500', family: 'Inter, sans-serif' }
        }
      },
      y: {
        grid: { color: 'rgba(255, 255, 255, 0.06)' },
        ticks: {
          color: 'rgba(235, 235, 245, 0.75)',
          font: { size: 12, weight: '500', family: 'Inter, sans-serif' },
          callback: (value) => '$' + value
        }
      }
    }
  }
});
</script>




{% endblock %}
